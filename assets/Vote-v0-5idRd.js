import{u as w,d as M,N as $,r as o,as as G,j as e,S as L,U as H,L as O,n as R}from"./index-XZ3gHdqT.js";import"./reviewService-Cy8ERe3s.js";import{p as v}from"./pollService-COCn_MVI.js";import{U as Y}from"./UserPrompt-pEh76OzT.js";const b=G({prefix:"VotePage"}),Z=20;function X(){const{t}=w(),{isLoading:d,getTopHabitable:r}=M(),{profile:l,loading:u}=$(),[i,g]=o.useState([]),[n,x]=o.useState(null),[U,y]=o.useState(0),[E,C]=o.useState(!0),[j,f]=o.useState(!1),[m,N]=o.useState(null),[V,P]=o.useState(!1),A=o.useMemo(()=>d?[]:[...r(Z)].sort((a,c)=>{var S,T;const h=((S=i.find(_=>_.planet===a.pl_name))==null?void 0:S.count)||0,k=((T=i.find(_=>_.planet===c.pl_name))==null?void 0:T.count)||0;return k!==h?k-h:c.habitability_score-a.habitability_score}),[d,r,i]);o.useEffect(()=>{async function s(){C(!0);try{const[a,c]=await Promise.all([v.getVoteCounts(),v.getTotalVotes()]);if(g(a),y(c),l){const h=await v.getUserVote(l.uid);x((h==null?void 0:h.planet)||null)}}catch(a){b.error("Failed to load vote data:",a)}finally{C(!1)}}s()},[l]);const D=o.useCallback(s=>{const a=i.find(c=>c.planet===s);return(a==null?void 0:a.count)||0},[i]),F=o.useMemo(()=>i.length===0?null:i[0].planet,[i]),z=o.useCallback(s=>{if(!l){N(s),f(!0);return}p(s)},[l]),p=o.useCallback(async s=>{if(!(!l||V)){P(!0);try{await v.castVote(s,l.uid),x(s);const[a,c]=await Promise.all([v.getVoteCounts(),v.getTotalVotes()]);g(a),y(c),b.info("Vote cast successfully:",s)}catch(a){b.error("Failed to cast vote:",a)}finally{P(!1)}}},[l,V]),B=o.useCallback(s=>{f(!1),b.info("Guest user created:",s)},[]),I=o.useCallback(()=>{f(!1),l&&m&&p(m),N(null)},[l,m,p]);return o.useEffect(()=>{l&&m&&!j&&(p(m),N(null))},[l,m,j,p]),d||u?e.jsxs("div",{className:"vote-loading",children:[e.jsx(L,{}),e.jsx("p",{children:t("pages.vote.loading")})]}):e.jsxs("div",{className:"vote-page",children:[e.jsxs("header",{className:"vote-header",children:[e.jsx("h1",{className:"vote-title",children:t("pages.vote.title")}),e.jsx("p",{className:"vote-subtitle",children:t("pages.vote.subtitle")}),e.jsxs("div",{className:"vote-stats",children:[e.jsx("span",{className:"vote-total",children:t("pages.vote.totalVotes",{count:U})}),n&&e.jsx("span",{className:"vote-your-pick",children:t("pages.vote.yourPick",{planet:n})})]})]}),e.jsx("section",{className:"vote-grid",children:A.map((s,a)=>e.jsx(q,{planet:s,rank:a+1,voteCount:D(s.pl_name),isLeader:s.pl_name===F,isUserVote:s.pl_name===n,isVoting:V,onVote:()=>z(s.pl_name)},s.pl_name))}),E&&!d&&e.jsx("div",{className:"vote-loading-overlay",children:e.jsx(L,{})}),j&&e.jsx(Y,{onSubmit:B,onClose:I})]})}function q({planet:t,rank:d,voteCount:r,isLeader:l,isUserVote:u,isVoting:i,onVote:g}){const{t:n}=w(),x=["vote-card",l&&r>0?"vote-card-leader":"",u?"vote-card-selected":""].filter(Boolean).join(" ");return e.jsxs("div",{className:x,children:[e.jsxs("div",{className:"vote-rank",children:[l&&r>0&&e.jsx("span",{className:"vote-crown",children:"ðŸ‘‘"}),"#",d]}),e.jsx("div",{className:"vote-card-visualization",children:e.jsx(H,{planet:t,size:64})}),e.jsxs("div",{className:"vote-card-content",children:[e.jsx(O,{to:`/planets/${R(t.pl_name)}`,className:"vote-planet-name",children:t.pl_name}),e.jsxs("div",{className:"vote-planet-score",children:[e.jsx("span",{className:"score-value",children:t.habitability_score.toFixed(1)}),e.jsx("span",{className:"score-label",children:"/ 100"})]}),e.jsxs("div",{className:"vote-planet-details",children:[t.planet_type&&e.jsx("span",{className:"detail-item",children:t.planet_type}),t.distance_ly&&e.jsxs("span",{className:"detail-item",children:[t.distance_ly.toFixed(1)," ",n("pages.vote.lightYears")]})]}),e.jsxs("div",{className:"vote-badges",children:[t.is_habitable_zone&&e.jsx("span",{className:"badge habitable",children:n("pages.habitability.charts.badges.habitableZone")}),t.is_earth_like&&e.jsx("span",{className:"badge earth-like",children:n("pages.habitability.charts.badges.earthLike")})]})]}),e.jsxs("div",{className:"vote-card-footer",children:[e.jsxs("div",{className:"vote-count",children:[e.jsx("span",{className:"vote-count-number",children:r}),e.jsx("span",{className:"vote-count-label",children:n("pages.vote.votes",{count:r})})]}),e.jsx("button",{className:`vote-button ${u?"vote-button-selected":""}`,onClick:g,disabled:i,children:n(u?"pages.vote.voted":"pages.vote.voteButton")})]}),u&&e.jsx("div",{className:"vote-selected-badge",children:n("pages.vote.yourChoice")})]})}export{X as default};
