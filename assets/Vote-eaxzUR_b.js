import{u as w,a as M,e as $,r as o,i as G,j as e,S as T,L as H,n as O}from"./index-cXPqB-ye.js";import"./reviewService-DsRJGVMe.js";import{p as h}from"./pollService-B4OjNysN.js";import{U as R}from"./UserPrompt-CGd_Gzbb.js";import{P as Y}from"./PlanetVisualization-B839RXBD.js";const j=G({prefix:"VotePage"}),Z=20;function ee(){const{t}=w(),{isLoading:d,getTopHabitable:r}=M(),{profile:l,loading:u}=$(),[i,g]=o.useState([]),[n,x]=o.useState(null),[U,y]=o.useState(0),[E,P]=o.useState(!0),[b,f]=o.useState(!1),[m,N]=o.useState(null),[V,C]=o.useState(!1),z=o.useMemo(()=>d?[]:[...r(Z)].sort((a,c)=>{var k,L;const v=((k=i.find(_=>_.planet===a.pl_name))==null?void 0:k.count)||0,S=((L=i.find(_=>_.planet===c.pl_name))==null?void 0:L.count)||0;return S!==v?S-v:c.habitability_score-a.habitability_score}),[d,r,i]);o.useEffect(()=>{async function s(){P(!0);try{const[a,c]=await Promise.all([h.getVoteCounts(),h.getTotalVotes()]);if(g(a),y(c),l){const v=await h.getUserVote(l.uid);x((v==null?void 0:v.planet)||null)}}catch(a){j.error("Failed to load vote data:",a)}finally{P(!1)}}s()},[l]);const A=o.useCallback(s=>{const a=i.find(c=>c.planet===s);return(a==null?void 0:a.count)||0},[i]),D=o.useMemo(()=>i.length===0?null:i[0].planet,[i]),F=o.useCallback(s=>{if(!l){N(s),f(!0);return}p(s)},[l]),p=o.useCallback(async s=>{if(!(!l||V)){C(!0);try{await h.castVote(s,l.uid),x(s);const[a,c]=await Promise.all([h.getVoteCounts(),h.getTotalVotes()]);g(a),y(c),j.info("Vote cast successfully:",s)}catch(a){j.error("Failed to cast vote:",a)}finally{C(!1)}}},[l,V]),B=o.useCallback(s=>{f(!1),j.info("Guest user created:",s)},[]),I=o.useCallback(()=>{f(!1),l&&m&&p(m),N(null)},[l,m,p]);return o.useEffect(()=>{l&&m&&!b&&(p(m),N(null))},[l,m,b,p]),d||u?e.jsxs("div",{className:"vote-loading",children:[e.jsx(T,{}),e.jsx("p",{children:t("pages.vote.loading")})]}):e.jsxs("div",{className:"vote-page",children:[e.jsxs("header",{className:"vote-header",children:[e.jsx("h1",{className:"vote-title",children:t("pages.vote.title")}),e.jsx("p",{className:"vote-subtitle",children:t("pages.vote.subtitle")}),e.jsxs("div",{className:"vote-stats",children:[e.jsx("span",{className:"vote-total",children:t("pages.vote.totalVotes",{count:U})}),n&&e.jsx("span",{className:"vote-your-pick",children:t("pages.vote.yourPick",{planet:n})})]})]}),e.jsx("section",{className:"vote-grid",children:z.map((s,a)=>e.jsx(q,{planet:s,rank:a+1,voteCount:A(s.pl_name),isLeader:s.pl_name===D,isUserVote:s.pl_name===n,isVoting:V,onVote:()=>F(s.pl_name)},s.pl_name))}),E&&!d&&e.jsx("div",{className:"vote-loading-overlay",children:e.jsx(T,{})}),b&&e.jsx(R,{onSubmit:B,onClose:I})]})}function q({planet:t,rank:d,voteCount:r,isLeader:l,isUserVote:u,isVoting:i,onVote:g}){const{t:n}=w(),x=["vote-card",l&&r>0?"vote-card-leader":"",u?"vote-card-selected":""].filter(Boolean).join(" ");return e.jsxs("div",{className:x,children:[e.jsxs("div",{className:"vote-rank",children:[l&&r>0&&e.jsx("span",{className:"vote-crown",children:"ðŸ‘‘"}),"#",d]}),e.jsx("div",{className:"vote-card-visualization",children:e.jsx(Y,{planet:t,size:64})}),e.jsxs("div",{className:"vote-card-content",children:[e.jsx(H,{to:`/planets/${O(t.pl_name)}`,className:"vote-planet-name",children:t.pl_name}),e.jsxs("div",{className:"vote-planet-score",children:[e.jsx("span",{className:"score-value",children:t.habitability_score.toFixed(1)}),e.jsx("span",{className:"score-label",children:"/ 100"})]}),e.jsxs("div",{className:"vote-planet-details",children:[t.planet_type&&e.jsx("span",{className:"detail-item",children:t.planet_type}),t.distance_ly&&e.jsxs("span",{className:"detail-item",children:[t.distance_ly.toFixed(1)," ",n("pages.vote.lightYears")]})]}),e.jsxs("div",{className:"vote-badges",children:[t.is_habitable_zone&&e.jsx("span",{className:"badge habitable",children:n("pages.habitability.charts.badges.habitableZone")}),t.is_earth_like&&e.jsx("span",{className:"badge earth-like",children:n("pages.habitability.charts.badges.earthLike")})]})]}),e.jsxs("div",{className:"vote-card-footer",children:[e.jsxs("div",{className:"vote-count",children:[e.jsx("span",{className:"vote-count-number",children:r}),e.jsx("span",{className:"vote-count-label",children:n("pages.vote.votes",{count:r})})]}),e.jsx("button",{className:`vote-button ${u?"vote-button-selected":""}`,onClick:g,disabled:i,children:n(u?"pages.vote.voted":"pages.vote.voteButton")})]}),u&&e.jsx("div",{className:"vote-selected-badge",children:n("pages.vote.yourChoice")})]})}export{ee as default};
