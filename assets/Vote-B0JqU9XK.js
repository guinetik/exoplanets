import{u as L,c as M,K as $,r as o,ar as G,j as e,S as w,T as H,E as K,n as O}from"./index-2bvuyZSE.js";import"./reviewService-C8XTZ8os.js";import{p as v}from"./pollService-C55KcngH.js";import{U as R}from"./UserPrompt-DdXImuVz.js";const b=G({prefix:"VotePage"}),Y=20;function X(){const{t}=L(),{isLoading:d,getTopHabitable:r}=M(),{profile:l,loading:u}=$(),[c,g]=o.useState([]),[n,x]=o.useState(null),[E,y]=o.useState(0),[U,C]=o.useState(!0),[j,f]=o.useState(!1),[m,N]=o.useState(null),[V,P]=o.useState(!1),A=o.useMemo(()=>d?[]:[...r(Y)].sort((a,i)=>{var S,T;const h=((S=c.find(_=>_.planet===a.pl_name))==null?void 0:S.count)||0,k=((T=c.find(_=>_.planet===i.pl_name))==null?void 0:T.count)||0;return k!==h?k-h:i.habitability_score-a.habitability_score}),[d,r,c]);o.useEffect(()=>{async function s(){C(!0);try{const[a,i]=await Promise.all([v.getVoteCounts(),v.getTotalVotes()]);if(g(a),y(i),l){const h=await v.getUserVote(l.uid);x((h==null?void 0:h.planet)||null)}}catch(a){b.error("Failed to load vote data:",a)}finally{C(!1)}}s()},[l]);const D=o.useCallback(s=>{const a=c.find(i=>i.planet===s);return(a==null?void 0:a.count)||0},[c]),F=o.useMemo(()=>c.length===0?null:c[0].planet,[c]),z=o.useCallback(s=>{if(!l){N(s),f(!0);return}p(s)},[l]),p=o.useCallback(async s=>{if(!(!l||V)){P(!0);try{await v.castVote(s,l.uid),x(s);const[a,i]=await Promise.all([v.getVoteCounts(),v.getTotalVotes()]);g(a),y(i),b.info("Vote cast successfully:",s)}catch(a){b.error("Failed to cast vote:",a)}finally{P(!1)}}},[l,V]),B=o.useCallback(s=>{f(!1),b.info("Guest user created:",s)},[]),I=o.useCallback(()=>{f(!1),l&&m&&p(m),N(null)},[l,m,p]);return o.useEffect(()=>{l&&m&&!j&&(p(m),N(null))},[l,m,j,p]),d||u?e.jsxs("div",{className:"vote-loading",children:[e.jsx(w,{}),e.jsx("p",{children:t("pages.vote.loading")})]}):e.jsxs("div",{className:"vote-page",children:[e.jsxs("header",{className:"vote-header",children:[e.jsx("h1",{className:"vote-title",children:t("pages.vote.title")}),e.jsx("p",{className:"vote-subtitle",children:t("pages.vote.subtitle")}),e.jsxs("div",{className:"vote-stats",children:[e.jsx("span",{className:"vote-total",children:t("pages.vote.totalVotes",{count:E})}),n&&e.jsx("span",{className:"vote-your-pick",children:t("pages.vote.yourPick",{planet:n})})]})]}),e.jsx("section",{className:"vote-grid",children:A.map((s,a)=>e.jsx(Z,{planet:s,rank:a+1,voteCount:D(s.pl_name),isLeader:s.pl_name===F,isUserVote:s.pl_name===n,isVoting:V,onVote:()=>z(s.pl_name)},s.pl_name))}),U&&!d&&e.jsx("div",{className:"vote-loading-overlay",children:e.jsx(w,{})}),j&&e.jsx(R,{onSubmit:B,onClose:I})]})}function Z({planet:t,rank:d,voteCount:r,isLeader:l,isUserVote:u,isVoting:c,onVote:g}){const{t:n}=L(),x=["vote-card",l&&r>0?"vote-card-leader":"",u?"vote-card-selected":""].filter(Boolean).join(" ");return e.jsxs("div",{className:x,children:[e.jsxs("div",{className:"vote-rank",children:[l&&r>0&&e.jsx("span",{className:"vote-crown",children:"ðŸ‘‘"}),"#",d]}),e.jsx("div",{className:"vote-card-visualization",children:e.jsx(H,{planet:t,size:64})}),e.jsxs("div",{className:"vote-card-content",children:[e.jsx(K,{to:`/planets/${O(t.pl_name)}`,className:"vote-planet-name",children:t.pl_name}),e.jsxs("div",{className:"vote-planet-score",children:[e.jsx("span",{className:"score-value",children:t.habitability_score.toFixed(1)}),e.jsx("span",{className:"score-label",children:"/ 100"})]}),e.jsxs("div",{className:"vote-planet-details",children:[t.planet_type&&e.jsx("span",{className:"detail-item",children:t.planet_type}),t.distance_ly&&e.jsxs("span",{className:"detail-item",children:[t.distance_ly.toFixed(1)," ",n("pages.vote.lightYears")]})]}),e.jsxs("div",{className:"vote-badges",children:[t.is_habitable_zone&&e.jsx("span",{className:"badge habitable",children:n("pages.habitability.charts.badges.habitableZone")}),t.is_earth_like&&e.jsx("span",{className:"badge earth-like",children:n("pages.habitability.charts.badges.earthLike")})]})]}),e.jsxs("div",{className:"vote-card-footer",children:[e.jsxs("div",{className:"vote-count",children:[e.jsx("span",{className:"vote-count-number",children:r}),e.jsx("span",{className:"vote-count-label",children:n("pages.vote.votes",{count:r})})]}),e.jsx("button",{className:`vote-button ${u?"vote-button-selected":""}`,onClick:g,disabled:c,children:n(u?"pages.vote.voted":"pages.vote.voteButton")})]}),u&&e.jsx("div",{className:"vote-selected-badge",children:n("pages.vote.yourChoice")})]})}export{X as default};
